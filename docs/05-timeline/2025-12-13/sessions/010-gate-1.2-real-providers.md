# üìÖ SESS√ÉO 2025-12-13 ‚Äî Gate 1.2: Real Providers + Validators

**SHA:** `3e803a4`

---

## üéØ Objetivo

Trocar stubs por **execu√ß√£o real** usando getEffectiveConfig, Provider configs do DB, Prompt com vers√£o, Presets, Validators e KB.

---

## ‚úÖ O que foi Implementado

### A) Claude Provider (kind=llm)

`lib/engine/providers.ts`:

```typescript
export async function executeLLM(config: LLMConfig): Promise<LLMResponse>
```

- Carrega prompt pelo binding (inclui version)
- Aplica template com inputs do job + contexto de KB
- Executa Claude via Anthropic API
- Salva no manifest: model, max_tokens, temperature, prompt_id, prompt_version
- Captura erros com error_code, error_message

### B) Azure TTS Provider (kind=tts)

```typescript
export async function executeTTS(config: TTSConfig): Promise<TTSResponse>
```

- Input vem do step anterior (text)
- Aplica preset_voice e preset_ssml
- Chama Azure TTS (Realtime API - nota: ser√° trocado por Batch no Gate 1.5.1)
- Salva artifact (arquivo .mp3/wav)

### C) Validators

```typescript
export function executeValidators(text: string, validators: Validator[]): ValidationResult
```

Tipos implementados:
- `forbidden_patterns` (regex/substring)
- `required_patterns`
- `min_words`
- `max_words`

Resultado registrado no manifest.

### D) Runner Phase 3

- Real providers por step kind
- Manifest version **3.0.0**
- Artifact storage: `./artifacts/{jobId}/{stepKey}/`
- Snapshot: config + outputs + artifacts + validations

### E) Corre√ß√µes de Tipos

- `PipelineStep` type exported
- `StepIndicator` fix
- `JobCardSkeleton` adicionado
- Dashboard simplificado

---

## üêõ Problemas Encontrados

1. **Lint error em createValidator:** Faltava errorMessage
2. **Import PipelineStep:** Tipo n√£o exportado do PipelineView
3. **systemPrompt nullable:** Corre√ß√£o de tipo no runner
4. **Prerendering error:** Erro de execu√ß√£o em tempo de build (corrigido no Gate 1.25)

---

## üìù Decis√µes T√©cnicas

1. **Secrets via ENV:** `apiKey` nunca aparece no manifest/logs
2. **Retry Support:** Step failed pode ser reiniciado
3. **Artifact URI:** Path local por enquanto; futuramente URL

---

## üîó Commit

```
feat: Gate 1.2 - Real Providers + Validators

A) Claude Provider (lib/engine/providers.ts):
- executeLLM com templates + KB context
- Anthropic API integration
- Request/response metadata

B) Azure TTS Provider:
- executeTTS com SSML building
- Voice/SSML preset application
- Azure Speech API integration

C) Validators:
- executeValidators: forbidden_patterns, required_patterns, min_words, max_words
- Validation results em manifest
- Step fails se valida√ß√£o falha

D) Runner Phase 3 (lib/engine/runner.ts):
- Real providers por step kind
- Manifest version 3.0.0
- Artifact storage ./artifacts/{jobId}/{stepKey}/
- Snapshot config + outputs + artifacts + validations

E) Components VF:
- StatusBadge, MetricCard, QuickAction, JobCard
- JobCardSkeleton
- PipelineStep type exported
- StepIndicator fix

F) Pages:
- Dashboard simplificado
- Job detail com mock corrigido
```

---

## ‚è≠Ô∏è Pr√≥ximo Gate

Gate 1.25 ‚Äî Governance + Traceability
