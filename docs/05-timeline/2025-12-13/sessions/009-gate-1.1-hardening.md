# üìÖ SESS√ÉO 2025-12-13 ‚Äî Gate 1.1: Hardening + Effective Config

**SHA:** `41575e1`

---

## üéØ Objetivo

Garantir que o Execution Map representa o fluxo real, com **StepCapabilities** por kind e **runner lendo getEffectiveConfig**.

---

## üìã Prompt do Usu√°rio (Contexto Original)

> **Execution Map s√≥ √© "real" se for a fonte de verdade do runner**, com step_keys can√¥nicos, slots corretos por step, valida√ß√µes, e snapshot no manifest.

---

## ‚úÖ O que foi Implementado

### A) StepCapabilities (`lib/engine/capabilities.ts`)

Mapeamento de slots permitidos por step kind:

| Kind | Slots Permitidos |
|------|------------------|
| **llm** | prompt, provider, kb, validators |
| **tts** | provider, preset_voice, preset_ssml, validators |
| **transform** | validators |
| **render** | preset_video, preset_effects |
| **export** | preset_video |

Helpers criados:
- `getStepKind(stepKey)`
- `getAllowedSlots(kind)`
- `isSlotAllowed(kind, slot)`
- `KIND_LABELS`, `SLOT_LABELS`

### B) Runner Phase 2 (`lib/engine/runner.ts`)

- `getEffectiveConfig` por step no in√≠cio do job
- `manifest.snapshots.config_by_step` com config completa
- Steps logam provider/prompt ids
- Manifest version **2.0.0**

### C) Execution Map Updates

- Filtra slots por step kind
- Mostra KIND_LABELS no subtitle
- Voice/SSML presets adicionados
- Badge de step kind no detail

### D) Admin Actions

```typescript
getVoicePresets()
getSsmlPresets()
getVideoPresets()
getEffectsPresets()
```

### E) Componentes VF Criados

| Componente | Descri√ß√£o |
|------------|-----------|
| **StatusBadge** | Badge de status (pending/running/success/failed) |
| **MetricCard** | Card de m√©trica com √≠cone |
| **QuickAction** | Bot√£o de a√ß√£o r√°pida |
| **QuickActionGroup** | Grupo de a√ß√µes |
| **JobCard** | Card de job para lista |

---

## üìù Decis√µes T√©cnicas

1. **Slots por Kind:** Evita nonsense (ex: TTS n√£o precisa de Prompt binding).
2. **setBinding Validation:** Valida slot x stepKind.
3. **Config Snapshot:** Salvo no manifest para auditoria.

---

## üîó Commit

```
feat: Gate 1.1 - Hardening + Effective Config

A) StepCapabilities (lib/engine/capabilities.ts):
- Mapeamento de slots por step kind (llm, tts, transform, render, export)
- getStepKind, getAllowedSlots, isSlotAllowed helpers
- KIND_LABELS, SLOT_LABELS para UI

B) Runner Phase 2 (lib/engine/runner.ts):
- getEffectiveConfig por step no in√≠cio do job
- manifest.snapshots.config_by_step com config completa
- Steps logam provider/prompt ids
- version 2.0.0 do manifest

C) Execution Map (/admin/execution-map):
- Filtra slots por step kind
- Mostra KIND_LABELS no subtitle
- Voice/SSML presets adicionados
- Badge de step kind no detail

D) Admin Actions:
- getVoicePresets, getSsmlPresets, getVideoPresets, getEffectsPresets

E) Componentes VF:
- StatusBadge
- MetricCard
- QuickAction, QuickActionGroup
- JobCard
```

---

## ‚è≠Ô∏è Pr√≥ximo Gate

Gate 1.2 ‚Äî Real Providers + Validators
